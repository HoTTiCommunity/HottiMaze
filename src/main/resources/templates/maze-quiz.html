<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${maze.mazeTitle} + ' 퀴즈 - HottiMaze'">미로 퀴즈 - HottiMaze</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    header {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      padding: 25px;
      text-align: center;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .quiz-content {
      padding: 30px;
    }

    .quiz-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e9ecef;
    }

    .quiz-title {
      font-size: 1.8rem;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .quiz-progress {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .progress-bar {
      flex: 1;
      max-width: 300px;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, #4ecdc4, #44a08d);
      transition: width 0.3s ease;
    }

    .progress-text {
      color: #6c757d;
      font-weight: bold;
    }

    .quiz-question {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .quiz-question.active {
      display: block;
      animation: slideIn 0.3s ease;
    }

    .question-number {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 10px;
      text-align: center;
    }

    .question-title {
      font-size: 1.4rem;
      color: #2c3e50;
      margin-bottom: 15px;
      font-weight: 600;
      text-align: center;
    }

    .question-content {
      font-size: 1.1rem;
      color: #495057;
      margin-bottom: 20px;
      text-align: center;
      line-height: 1.6;
    }

    .question-image {
      width: 100%;
      max-width: 400px;
      height: 250px;
      object-fit: cover;
      border-radius: 15px;
      margin: 0 auto 20px;
      display: block;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .quiz-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 30px;
    }

    .option-button {
      padding: 15px 20px;
      border: 2px solid #e9ecef;
      background: white;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      font-size: 1rem;
      font-weight: 500;
      color: #495057;
    }

    .option-button:hover {
      border-color: #4ecdc4;
      background: #f8f9fa;
      transform: translateY(-2px);
    }

    .option-button.selected {
      border-color: #4ecdc4;
      background: linear-gradient(45deg, #4ecdc4, #44a08d);
      color: white;
    }

    .option-button.correct {
      border-color: #28a745;
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
    }

    .option-button.incorrect {
      border-color: #dc3545;
      background: linear-gradient(45deg, #dc3545, #e83e8c);
      color: white;
    }

    .quiz-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 15px;
    }

    .quiz-timer {
      background: linear-gradient(45deg, #ff9a9e, #fecfef);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .quiz-nav {
      display: flex;
      gap: 15px;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(45deg, #4ecdc4, #44a08d);
      color: white;
      box-shadow: 0 5px 20px rgba(78, 205, 196, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(45deg, #95a5a6, #7f8c8d);
      color: white;
      box-shadow: 0 5px 20px rgba(149, 165, 166, 0.3);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(149, 165, 166, 0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .quiz-result {
      text-align: center;
      padding: 50px;
      display: none;
    }

    .quiz-result.show {
      display: block;
      animation: slideIn 0.5s ease;
    }

    .result-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .result-title {
      font-size: 2rem;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .result-score {
      font-size: 1.3rem;
      color: #6c757d;
      margin-bottom: 30px;
    }

    .result-details {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }

    .success {
      color: #28a745;
    }

    .fail {
      color: #dc3545;
    }

    .back-button {
      position: fixed;
      top: 30px;
      left: 30px;
      background: rgba(255, 255, 255, 0.9);
      color: #2c3e50;
      border: none;
      border-radius: 50px;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      text-decoration: none;
      z-index: 1000;
    }

    .back-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      color: #2c3e50;
      text-decoration: none;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .quiz-options {
        grid-template-columns: 1fr;
      }

      .quiz-content {
        padding: 20px;
      }

      .quiz-controls {
        flex-direction: column;
        gap: 15px;
      }

      .quiz-nav {
        width: 100%;
        justify-content: center;
      }

      .back-button {
        position: static;
        margin: 10px;
        width: fit-content;
      }
    }
  </style>
</head>
<body>
<a th:href="@{'/mazes/' + ${maze.id}}" class="back-button">
  ← 미로로 돌아가기
</a>

<div class="container">
  <header>
    <h1>🧩 미궁 퀴즈</h1>
    <p th:text="${maze.mazeTitle} + ' 문제를 풀어보세요!'">미로 문제를 풀어보세요!</p>
  </header>

  <div class="quiz-content">
    <!-- 퀴즈 시작 화면 -->
    <div id="quizStart" class="quiz-header">
      <h2 class="quiz-title" th:text="${maze.mazeTitle} + ' 퀴즈'">미로 퀴즈</h2>
      <p style="color: #6c757d; margin-bottom: 20px;">
        총 <span th:text="${#lists.size(questions)}">3</span>개의 문제가 있습니다.<br>
        각 문제당 30초의 시간이 주어집니다.
      </p>

      <!-- 디버깅 정보 추가 -->
      <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 0.8rem;">
        <strong>디버깅 정보:</strong><br>
        미로 ID: <span th:text="${maze.id}">1</span><br>
        미로 제목: <span th:text="${maze.mazeTitle}">제목</span><br>
        문제 개수: <span th:text="${#lists.size(questions)}">0</span><br>
        <div th:each="q, iterStat : ${questions}">
          문제 <span th:text="${iterStat.index + 1}">1</span>: <span th:text="${q.title}">제목없음</span>
        </div>
      </div>

      <div th:if="${questions.isEmpty()}" class="alert" style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
        이 미로에는 아직 문제가 등록되지 않았습니다.
      </div>
      <button class="btn btn-primary" onclick="startQuiz()" th:disabled="${questions.isEmpty()}">
        🚀 퀴즈 시작하기
      </button>
    </div>

    <!-- 진행률 표시 -->
    <div id="quizProgress" class="quiz-progress" style="display: none;">
      <span class="progress-text" id="currentQuestion">1</span>
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
      </div>
      <span class="progress-text" id="totalQuestions" th:text="${#lists.size(questions)}">3</span>
    </div>

    <!-- 문제들 -->
    <div id="quizQuestions">
      <div th:each="question, iterStat : ${questions}"
           class="quiz-question"
           th:data-question-id="${question.id}"
           th:data-correct-answer="${question.correctAnswer}">

        <div class="question-number" th:text="'문제 ' + ${iterStat.index + 1} + '/' + ${#lists.size(questions)}">문제 1/3</div>
        <h3 class="question-title" th:text="${question.title ?: '제목 없음'}">문제 제목</h3>
        <p class="question-content" th:text="${question.content ?: '내용 없음'}">문제 내용</p>

        <!-- 디버깅 정보 -->
        <div style="background: #e9ecef; padding: 5px; margin: 10px 0; font-size: 0.7rem; border-radius: 3px;">
          ID: <span th:text="${question.id}">-</span> |
          순서: <span th:text="${question.questionOrder}">-</span> |
          정답: <span th:text="${question.correctAnswer}">-</span>
        </div>

        <img th:if="${question.questionImage and question.questionImage != ''}"
             th:src="${question.questionImage}"
             th:alt="${question.title}"
             class="question-image"
             onerror="this.style.display='none'">

        <div class="quiz-options">
          <button class="option-button" th:text="${question.option1 ?: '선택지 1'}" onclick="selectAnswer(1, this)">선택지 1</button>
          <button class="option-button" th:text="${question.option2 ?: '선택지 2'}" onclick="selectAnswer(2, this)">선택지 2</button>
          <button class="option-button" th:text="${question.option3 ?: '선택지 3'}" onclick="selectAnswer(3, this)">선택지 3</button>
          <button class="option-button" th:text="${question.option4 ?: '선택지 4'}" onclick="selectAnswer(4, this)">선택지 4</button>
        </div>
      </div>
    </div>

    <!-- 컨트롤 버튼 -->
    <div id="quizControls" class="quiz-controls" style="display: none;">
      <div class="quiz-timer" id="quizTimer">⏰ 30초</div>
      <div class="quiz-nav">
        <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()" style="display: none;">이전</button>
        <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>다음</button>
      </div>
    </div>

    <!-- 결과 화면 -->
    <div id="quizResult" class="quiz-result">
      <div class="result-icon" id="resultIcon">🎉</div>
      <div class="result-title" id="resultTitle">축하합니다!</div>
      <div class="result-score" id="resultScore">3문제 중 2문제를 맞추셨습니다!</div>

      <div class="result-details">
        <h4 style="margin-bottom: 15px; color: #2c3e50;">상세 결과</h4>
        <div id="resultDetails"></div>
      </div>

      <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="restartQuiz()">다시 도전</button>
        <a th:href="@{'/mazes/' + ${maze.id}}" class="btn btn-secondary">미로로 돌아가기</a>
        <a href="/" class="btn btn-secondary">메인으로</a>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  // 서버에서 전달받은 데이터
  const questions = /*[[${questions}]]*/ [];
  const mazeId = /*[[${maze.id}]]*/ 1;

  // 퀴즈 관련 변수
  let currentQuestionIndex = 0;
  let userAnswers = [];
  let timeLeft = 30;
  let quizTimer = null;
  let selectedAnswer = null;

  // 퀴즈 시작
  function startQuiz() {
    if (questions.length === 0) {
      alert('문제가 없어서 퀴즈를 시작할 수 없습니다.');
      return;
    }

    document.getElementById('quizStart').style.display = 'none';
    document.getElementById('quizProgress').style.display = 'flex';
    document.getElementById('quizControls').style.display = 'flex';

    currentQuestionIndex = 0;
    userAnswers = [];
    showQuestion();
    startTimer();
  }

  // 문제 표시
  function showQuestion() {
    // 모든 문제 숨기기
    const allQuestions = document.querySelectorAll('.quiz-question');
    allQuestions.forEach(q => q.classList.remove('active'));

    // 현재 문제 표시
    if (currentQuestionIndex < allQuestions.length) {
      allQuestions[currentQuestionIndex].classList.add('active');
    }

    // 진행률 업데이트
    const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;

    // 버튼 상태 업데이트
    selectedAnswer = null;
    document.getElementById('nextBtn').disabled = true;
    document.getElementById('prevBtn').style.display = currentQuestionIndex > 0 ? 'block' : 'none';

    // 선택 초기화
    const options = allQuestions[currentQuestionIndex].querySelectorAll('.option-button');
    options.forEach(option => {
      option.classList.remove('selected', 'correct', 'incorrect');
    });

    // 타이머 리셋
    timeLeft = 30;
    updateTimer();
  }

  // 답변 선택
  function selectAnswer(answerIndex, button) {
    const currentQuestion = document.querySelectorAll('.quiz-question')[currentQuestionIndex];
    const options = currentQuestion.querySelectorAll('.option-button');

    // 기존 선택 해제
    options.forEach(opt => opt.classList.remove('selected'));

    // 새로운 선택
    button.classList.add('selected');
    selectedAnswer = answerIndex;
    document.getElementById('nextBtn').disabled = false;
  }

  // 다음 문제
  function nextQuestion() {
    if (selectedAnswer === null) return;

    // 답변 저장
    userAnswers[currentQuestionIndex] = selectedAnswer;

    // 정답 표시
    const currentQuestion = document.querySelectorAll('.quiz-question')[currentQuestionIndex];
    const correctAnswer = parseInt(currentQuestion.dataset.correctAnswer);
    const options = currentQuestion.querySelectorAll('.option-button');

    options.forEach((option, index) => {
      if (index + 1 === correctAnswer) {
        option.classList.add('correct');
      } else if (index + 1 === selectedAnswer && index + 1 !== correctAnswer) {
        option.classList.add('incorrect');
      }
    });

    // 잠시 결과 보여주기
    setTimeout(() => {
      currentQuestionIndex++;

      if (currentQuestionIndex >= questions.length) {
        showResult();
      } else {
        showQuestion();
      }
    }, 1500);
  }

  // 이전 문제
  function prevQuestion() {
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      showQuestion();

      // 이전 답변 복원
      if (userAnswers[currentQuestionIndex]) {
        const currentQuestion = document.querySelectorAll('.quiz-question')[currentQuestionIndex];
        const options = currentQuestion.querySelectorAll('.option-button');
        const previousAnswer = userAnswers[currentQuestionIndex];

        if (previousAnswer) {
          options[previousAnswer - 1].classList.add('selected');
          selectedAnswer = previousAnswer;
          document.getElementById('nextBtn').disabled = false;
        }
      }
    }
  }

  // 결과 표시
  function showResult() {
    document.getElementById('quizProgress').style.display = 'none';
    document.getElementById('quizControls').style.display = 'none';
    document.querySelector('.quiz-question.active').classList.remove('active');

    const score = calculateScore();
    const percentage = Math.round((score / questions.length) * 100);

    let resultIcon, resultTitle, resultClass;

    if (percentage >= 80) {
      resultIcon = '🎉';
      resultTitle = '완벽합니다!';
      resultClass = 'success';
    } else if (percentage >= 60) {
      resultIcon = '👏';
      resultTitle = '잘했어요!';
      resultClass = 'success';
    } else {
      resultIcon = '😅';
      resultTitle = '다시 도전해보세요!';
      resultClass = 'fail';
    }

    document.getElementById('resultIcon').textContent = resultIcon;
    document.getElementById('resultTitle').textContent = resultTitle;
    document.getElementById('resultTitle').className = `result-title ${resultClass}`;
    document.getElementById('resultScore').textContent =
            `${questions.length}문제 중 ${score}문제를 맞추셨습니다! (${percentage}%)`;

    // 상세 결과 표시
    showDetailedResults();

    document.getElementById('quizResult').classList.add('show');
    stopTimer();
  }

  // 상세 결과 표시
  function showDetailedResults() {
    const detailsContainer = document.getElementById('resultDetails');
    let detailsHTML = '';

    questions.forEach((question, index) => {
      const userAnswer = userAnswers[index] || 0;
      const isCorrect = userAnswer === question.correctAnswer;
      const icon = isCorrect ? '✅' : '❌';

      detailsHTML += `
                <div style="margin-bottom: 10px; padding: 10px; background: ${isCorrect ? '#d4edda' : '#f8d7da'}; border-radius: 8px;">
                    ${icon} <strong>문제 ${index + 1}:</strong> ${question.title}<br>
                    <small style="color: #6c757d;">
                        정답: ${getOptionText(question, question.correctAnswer)} |
                        선택: ${userAnswer ? getOptionText(question, userAnswer) : '선택하지 않음'}
                    </small>
                </div>
            `;
    });

    detailsContainer.innerHTML = detailsHTML;
  }

  // 선택지 텍스트 가져오기
  function getOptionText(question, optionNumber) {
    switch(optionNumber) {
      case 1: return question.option1;
      case 2: return question.option2;
      case 3: return question.option3;
      case 4: return question.option4;
      default: return '없음';
    }
  }

  // 점수 계산
  function calculateScore() {
    let score = 0;
    questions.forEach((question, index) => {
      if (userAnswers[index] === question.correctAnswer) {
        score++;
      }
    });
    return score;
  }

  // 퀴즈 재시작
  function restartQuiz() {
    document.getElementById('quizResult').classList.remove('show');
    document.getElementById('quizStart').style.display = 'block';
    currentQuestionIndex = 0;
    userAnswers = [];
    selectedAnswer = null;
  }

  // 타이머 시작
  function startTimer() {
    quizTimer = setInterval(() => {
      timeLeft--;
      updateTimer();

      if (timeLeft <= 0) {
        // 시간 초과 시 자동으로 다음 문제로
        if (selectedAnswer !== null) {
          nextQuestion();
        } else {
          // 선택하지 않은 경우 0으로 저장하고 다음 문제로
          userAnswers[currentQuestionIndex] = 0;
          currentQuestionIndex++;
          if (currentQuestionIndex >= questions.length) {
            showResult();
          } else {
            showQuestion();
          }
        }
      }
    }, 1000);
  }

  // 타이머 정지
  function stopTimer() {
    if (quizTimer) {
      clearInterval(quizTimer);
      quizTimer = null;
    }
  }

  // 타이머 업데이트
  function updateTimer() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('quizTimer').textContent = `⏰ ${timeString}`;

    // 시간이 10초 미만일 때 색상 변경
    const timerElement = document.getElementById('quizTimer');
    if (timeLeft <= 10) {
      timerElement.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
    } else {
      timerElement.style.background = 'linear-gradient(45deg, #ff9a9e, #fecfef)';
    }
  }

  // ESC 키로 퀴즈 종료
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      if (confirm('퀴즈를 종료하시겠습니까?')) {
        window.location.href = '/mazes/' + mazeId;
      }
    }
  });
</script>
</body>
</html>